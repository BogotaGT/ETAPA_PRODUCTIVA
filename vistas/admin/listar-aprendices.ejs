<!-- vistas/admin/listar-aprendices.ejs -->
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Listar Aprendices - SENA</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.24/css/jquery.dataTables.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/buttons/1.7.0/css/buttons.dataTables.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/fixedcolumns/3.3.2/css/fixedColumns.dataTables.min.css">
    <link rel="stylesheet" href="/css/styles.css">
    <link rel="stylesheet" href="/css/admin-styles.css">
    <style>
        .dataTables_wrapper .dataTables_filter {
            float: left;
            text-align: left;
        }
        .table th, .table td {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .table {
            border-collapse: collapse;
        }
        .table th, .table td {
            border: 1px solid #ddd;
        }
    </style>
</head>
<body>
<%- include('../parciales/admin-header') %>

<div class="container-fluid mt-4">
    <h2>Listado de Aprendices</h2>

    <div class="mb-3">
        <form id="searchForm" class="row g-3">
            <div class="col-md-3">
                <input type="text" class="form-control" name="nombre" placeholder="Nombre o Apellido">
            </div>
            <div class="col-md-3">
                <input type="text" class="form-control" name="documento" placeholder="Número de Documento">
            </div>
            <div class="col-md-3">
                <select class="form-control" name="programaFormacion">
                    <option value="">Seleccione Programa</option>
                    <option value="tecnoActividadFisica">Tecnología en actividad física</option>
                    <option value="tecnoEntrenamientoDeportivo">Tecnología en entrenamiento deportivo</option>
                </select>
            </div>
            <div class="col-md-2">
                <select class="form-control" name="alternativaSeleccionada">
                    <option value="">Seleccione Alternativa</option>
                    <option value="contratoAprendizaje">Contrato de Aprendizaje</option>
                    <option value="pasantia">Pasantía</option>
                    <option value="proyectosProductivos">Proyectos Productivos</option>
                    <option value="vinculoLaboral">Vínculo laboral</option>
                    <option value="proyectosProductivos">Proyectos productivos</option>
                    <option value="monitoria">Monitoría</option>
                    <option value="unidadesProductivas">Unidades productivas familiares</option>
                </select>
            </div>
            <div class="col-md-1">
                <button type="submit" class="btn btn-primary">Buscar</button>
            </div>
            <div class="col">
                <button id="buscarBtn" class="btn btn-primary">Buscar</button>
                <button id="limpiarFiltrosBtn" class="btn btn-secondary">Limpiar Filtros</button>
            </div>
        </form>
    </div>

    <table id="aprendicesTable" class="table table-striped table-bordered">
        <thead>
        <tr>
            <th>Tipo Documento</th>
            <th>Número Documento</th>
            <th>Estado Formación</th>
            <th>Nombres</th>
            <th>Primer Apellido</th>
            <th>Segundo Apellido</th>
            <th>Fecha Nacimiento</th>
            <th>EPS</th>
            <th>Teléfono Fijo</th>
            <th>Celular</th>
            <th>Dirección</th>
            <th>Barrio</th>
            <th>Departamento</th>
            <th>Municipio</th>
            <th>Correo Electrónico</th>
            <th>Fecha Inicio Formación</th>
            <th>Fecha Inicio Lectiva</th>
            <th>Fecha Fin Lectiva</th>
            <th>Fecha Inicio Productiva</th>
            <th>Fecha Fin Productiva</th>
            <th>Instructor Lectiva</th>
            <th>Instructor Productiva</th>
            <th>Número Ficha</th>
            <th>Programa Formación</th>
            <th>Alternativa Seleccionada</th>
            <th>Área Formación</th>
            <th>Empresa Patrocinadora</th>
            <th>Área Práctica</th>
            <th>Jefe Inmediato</th>
            <th>Teléfono Empresa</th>
            <th>Celular Empresa</th>
            <th>Dirección Empresa</th>
            <th>Correo Empresa</th>
            <th>Horario</th>
            <th>Acciones</th>
        </tr>
        </thead>
    </table>
</div>

<%- include('../parciales/admin-footer') %>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.datatables.net/1.10.24/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.10.24/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/1.7.0/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/1.7.0/js/buttons.bootstrap5.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"></script>
<script src="https://cdn.datatables.net/buttons/1.7.0/js/buttons.html5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/1.7.0/js/buttons.print.min.js"></script>
<script src="https://cdn.datatables.net/fixedheader/3.1.8/js/dataTables.fixedHeader.min.js"></script>
<script src="https://cdn.datatables.net/fixedcolumns/3.3.2/js/dataTables.fixedColumns.min.js"></script>

<script>
    $(document).ready(function() {
        var table = $('#aprendicesTable').DataTable({
            serverSide: true,
            processing: true,
            ajax: {
                url: '/admin/aprendices-data',
                type: 'POST',
                data: function (d) {
                    var formData = $('#searchForm').serializeArray();
                    $.each(formData, function (i, field) {
                        d[field.name] = field.value;
                    });
                }
            },
            columns: [
                {data: 'tipoDocumento'},
                {data: 'numeroDocumento'},
                {data: 'estadoFormacion'},
                {data: 'nombres'},
                {data: 'primerApellido'},
                {data: 'segundoApellido'},
                {data: 'fechaNacimiento'},
                {data: 'eps'},
                {data: 'telefonoFijo'},
                {data: 'celular'},
                {data: 'direccion'},
                {data: 'barrio'},
                {data: 'departamento'},
                {data: 'municipio'},
                {data: 'correoElectronico'},
                {data: 'fechaInicioFormacion'},
                {data: 'fechaInicioLectiva'},
                {data: 'fechaFinLectiva'},
                {data: 'fechaInicioProductiva'},
                {data: 'fechaFinProductiva'},
                {data: 'instructorLectiva'},
                {data: 'instructorProductiva'},
                {data: 'numeroFicha'},
                {data: 'programaFormacion'},
                {data: 'alternativaSeleccionada'},
                {data: 'areaFormacion'},
                {data: 'empresaPatrocinadora'},
                {data: 'areaPractica'},
                {data: 'jefeInmediato'},
                {data: 'telefonoEmpresa'},
                {data: 'celularEmpresa'},
                {data: 'direccionEmpresa'},
                {data: 'correoEmpresa'},
                {data: 'horario'},
                {
                    data: null,
                    render: function (data, type, row) {
                        return '<a href="/admin/aprendiz/' + row.id + '" class="btn btn-sm btn-primary">Ver</a> ' +
                            '<a href="/admin/aprendiz/editar/' + row.id + '" class="btn btn-sm btn-warning">Editar</a> ' +
                            '<button class="btn btn-sm btn-danger eliminar-aprendiz" data-id="' + row.id + '">Eliminar</button>';
                    }
                }
            ],
            order: [[1, 'asc']],
            pageLength: 10,
            dom: 'Bfrtip',
            buttons: [
                'excel',
                {
                    extend: 'print',
                    text: 'Imprimir/PDF',
                    customize: function (win) {
                        $(win.document.body).css('font-size', '10pt');
                        $(win.document.body).find('table')
                            .addClass('compact')
                            .css({
                                'font-size': 'inherit',
                                'border-collapse': 'collapse',
                                'width': '100%'
                            });
                        $(win.document.body).find('table th, table td')
                            .css({
                                'border': '1px solid #ddd',
                                'padding': '3px'
                            });
                    },
                    exportOptions: {
                        columns: ':visible'
                    }
                }
            ],
            scrollX: true,
            scrollY: '70vh',
            scrollCollapse: true,
            language: {
                url: '//cdn.datatables.net/plug-ins/1.10.24/i18n/Spanish.json'
            }
        });

        // Manejar la búsqueda
        $('#searchForm').on('submit', function(e) {
            e.preventDefault();
            table.ajax.reload();
        });

        // Manejar la eliminación de aprendices
        $('#aprendicesTable').on('click', '.eliminar-aprendiz', function() {
            var id = $(this).data('id');
            if(confirm('¿Estás seguro de que quieres eliminar este aprendiz?')) {
                $.ajax({
                    url: '/admin/aprendiz/eliminar/' + id,
                    type: 'DELETE',
                    success: function(response) {
                        if(response.success) {
                            alert('Aprendiz eliminado con éxito');
                            table.ajax.reload();
                        } else {
                            alert('Error al eliminar el aprendiz: ' + response.message);
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('Error:', error);
                        alert('Error al eliminar el aprendiz');
                    }
                });
            }
        });

        // Manejar la limpieza de filtros
        $('#limpiarFiltrosBtn').on('click', function(e) {
            e.preventDefault();
            $('#searchForm')[0].reset();
            table.search('').columns().search('').draw();
        });
    });
    // Manejar errores de parsing JSON
    window.addEventListener('storage', function(e) {
        if (e.key && e.newValue) {
            try {
                if (typeof e.newValue === 'string') {
                    JSON.parse(e.newValue);
                }
            } catch (error) {
                console.warn('Error parsing storage value for key ' + e.key + ':', error);
                // Opcional: limpiar el valor problemático
                // localStorage.removeItem(e.key);
            }
        }
    });
</script>
</body>
</html>