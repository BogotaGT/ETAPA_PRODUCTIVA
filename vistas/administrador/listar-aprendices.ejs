<!-- Ruta: vistas/administrados/listar-aprendices.ejs -->
<!-- Propósito: Interfaz de administrador para gestión de aprendices.
     Se enfoca en la presentación y delegación de funcionalidad a utilidadesAdmin.js -->

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Listar Aprendices - SENA</title>

    <!-- Estilos -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.24/css/jquery.dataTables.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/buttons/1.7.0/css/buttons.dataTables.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/fixedcolumns/3.3.2/css/fixedColumns.dataTables.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" href="/css/styles.css">
    <link rel="stylesheet" href="/css/admin-styles.css">
</head>
<body>
<%- include('../parciales/admin-header') %>

<!-- Barra de navegación específica del administrador -->
<nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container-fluid">
        <ul class="navbar-nav">
            <li class="nav-item">
                <a class="nav-link" href="/admin/dashboard">Regresar</a>
            </li>
            <li class="nav-item">
                <a class="nav-link active" href="/admin/listar-aprendices">Listar Aprendices</a>
            </li>
        </ul>
    </div>
</nav>

<div class="container-fluid mt-4">
    <div class="card">
        <div class="card-header bg-primary text-white">
            <div class="d-flex justify-content-between align-items-center">
                <h2 class="mb-0">Listado de Aprendices</h2>
                <div>
                    <button id="exportExcel" class="btn btn-success btn-sm">
                        <i class="fas fa-file-excel"></i> Excel
                    </button>
                    <button id="exportPDF" class="btn btn-danger btn-sm">
                        <i class="fas fa-file-pdf"></i> PDF
                    </button>
                </div>
            </div>
        </div>
        <div class="card-body">
            <!-- Filtros de búsqueda -->
            <form id="searchForm" class="row g-3 mb-4">
                <div class="col-md-3">
                    <label for="nombreBusqueda" class="form-label">Nombre o Apellido</label>
                    <input type="text" class="form-control" id="nombreBusqueda" name="nombre">
                </div>
                <div class="col-md-3">
                    <label for="documentoBusqueda" class="form-label">Número de Documento</label>
                    <input type="text" class="form-control" id="documentoBusqueda" name="documento">
                </div>
                <div class="col-md-3">
                    <label for="programaBusqueda" class="form-label">Programa</label>
                    <select class="form-select" id="programaBusqueda" name="programaFormacion">
                        <option value="">Seleccione Programa</option>
                        <option value="tecnoActividadFisica">Tecnología en actividad física</option>
                        <option value="tecnoEntrenamientoDeportivo">Tecnología en entrenamiento deportivo</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="alternativaBusqueda" class="form-label">Alternativa</label>
                    <select class="form-select" id="alternativaBusqueda" name="alternativaSeleccionada">
                        <option value="">Seleccione Alternativa</option>
                        <option value="contratoAprendizaje">Contrato de Aprendizaje</option>
                        <option value="pasantia">Pasantía</option>
                        <option value="proyectosProductivos">Proyectos Productivos</option>
                        <option value="vinculoLaboral">Vínculo laboral</option>
                        <option value="monitoria">Monitoría</option>
                        <option value="unidadesProductivas">Unidades productivas familiares</option>
                    </select>
                </div>
                <div class="col-12">
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-search"></i> Buscar
                        </button>
                        <button type="button" id="limpiarFiltrosBtn" class="btn btn-secondary">
                            <i class="fas fa-eraser"></i> Limpiar Filtros
                        </button>
                    </div>
                </div>
            </form>

            <!-- Tabla de Aprendices -->
            <div class="table-responsive">
                <table id="aprendicesTable" class="table table-striped table-bordered">
                    <thead class="table-dark">
                    <tr>
                        <th>Tipo Doc.</th>
                        <th>Número Doc.</th>
                        <th>Estado Form.</th>
                        <th>Nombres</th>
                        <th>Primer Apellido</th>
                        <th>Segundo Apellido</th>
                        <th>Fecha Nac.</th>
                        <th>EPS</th>
                        <th>Teléfono</th>
                        <th>Celular</th>
                        <th>Dirección</th>
                        <th>Barrio</th>
                        <th>Departamento</th>
                        <th>Municipio</th>
                        <th>Email</th>
                        <th>F. Inicio Form.</th>
                        <th>F. Inicio Lect.</th>
                        <th>F. Fin Lect.</th>
                        <th>F. Inicio Prod.</th>
                        <th>F. Fin Prod.</th>
                        <th>Inst. Lectiva</th>
                        <th>Inst. Productiva</th>
                        <th>N° Ficha</th>
                        <th>Programa</th>
                        <th>Alternativa</th>
                        <th>Área Form.</th>
                        <th>Empresa</th>
                        <th>Área Práctica</th>
                        <th>Jefe Inm.</th>
                        <th>Tel. Empresa</th>
                        <th>Cel. Empresa</th>
                        <th>Dir. Empresa</th>
                        <th>Email Empresa</th>
                        <th>Horario</th>
                        <th>Acciones</th>
                    </tr>
                    </thead>
                </table>
            </div>
        </div>
    </div>
</div>
<!-- Modal de confirmación para eliminar -->
<div class="modal fade" id="confirmDeleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirmar Eliminación</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                ¿Está seguro de que desea eliminar este aprendiz?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger" id="confirmDelete">Eliminar</button>
            </div>
        </div>
    </div>
</div>

<div id="messageContainer" class="message-container"></div>

<%- include('../parciales/admin-footer') %>

<!-- Scripts -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.datatables.net/1.10.24/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/buttons/1.7.0/js/dataTables.buttons.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"></script>
<script src="https://cdn.datatables.net/buttons/1.7.0/js/buttons.html5.min.js"></script>

<!-- Script principal -->
<!-- Script principal -->
<script type="module">
    import { showSuccessMessage, showErrorMessage } from '/js/utils.js';
    import utilidadesAdmin from '/js/utilidadesAdmin.js';

    document.addEventListener('DOMContentLoaded', function() {
        // Inicialización de la tabla
        const tabla = $('#aprendicesTable').DataTable({
            serverSide: true,
            processing: true,
            ajax: {
                url: '/admin/aprendices-data',
                type: 'POST',
                data: function(d) {
                    const formData = new FormData(document.getElementById('searchForm'));
                    for (const [key, value] of formData.entries()) {
                        d[key] = value;
                    }
                }
            },
            columns: [
                { data: "tipoDocumento" },
                { data: "numeroDocumento" },
                { data: "estadoFormacion" },
                { data: "nombres" },
                { data: "primerApellido" },
                { data: "segundoApellido" },
                { data: "fechaNacimiento" },
                { data: "eps" },
                { data: "telefonoFijo" },
                { data: "celular" },
                { data: "direccion" },
                { data: "barrio" },
                { data: "departamento" },
                { data: "municipio" },
                { data: "correoElectronico" },
                { data: "fechaInicioFormacion" },
                { data: "fechaInicioLectiva" },
                { data: "fechaFinLectiva" },
                { data: "fechaInicioProductiva" },
                { data: "fechaFinProductiva" },
                { data: "instructorLectiva" },
                { data: "instructorProductiva" },
                { data: "numeroFicha" },
                { data: "programaFormacion" },
                { data: "alternativaSeleccionada" },
                { data: "areaFormacion" },
                { data: "empresaPatrocinadora" },
                { data: "areaPractica" },
                { data: "jefeInmediato" },
                { data: "telefonoEmpresa" },
                { data: "celularEmpresa" },
                { data: "direccionEmpresa" },
                { data: "correoEmpresa" },
                { data: "horario" },
                {
                    data: null,
                    render: function(data, type, row) {
                        return `
                                <div class="btn-group btn-group-sm">
                                    <a href="/admin/aprendiz/${row.id}" class="btn btn-info">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                    <a href="/admin/aprendiz/editar/${row.id}" class="btn btn-warning">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                    <button class="btn btn-danger eliminar-aprendiz" data-id="${row.id}">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            `;
                    }
                }
            ],
            language: {
                url: '//cdn.datatables.net/plug-ins/1.10.24/i18n/Spanish.json'
            },
            dom: 'Bfrtip',
            buttons: [
                {
                    extend: 'excel',
                    className: 'btn btn-success',
                    text: '<i class="fas fa-file-excel"></i> Excel',
                    exportOptions: {
                        columns: ':not(:last-child)'
                    }
                },
                {
                    extend: 'pdf',
                    className: 'btn btn-danger',
                    text: '<i class="fas fa-file-pdf"></i> PDF',
                    exportOptions: {
                        columns: ':not(:last-child)'
                    }
                }
            ],
            scrollX: true,
            scrollY: '60vh',
            scrollCollapse: true,
            orderCellsTop: true,
            fixedHeader: true
        });

        // Event Listeners
        document.getElementById('searchForm').addEventListener('submit', function(e) {
            e.preventDefault();
            tabla.ajax.reload();
            showSuccessMessage('Búsqueda realizada');
        });

        document.getElementById('limpiarFiltrosBtn').addEventListener('click', function() {
            document.getElementById('searchForm').reset();
            tabla.search('').columns().search('').draw();
            showSuccessMessage('Filtros limpiados');
        });

        // Manejo de eliminación
        const confirmDeleteModal = new bootstrap.Modal(document.getElementById('confirmDeleteModal'));
        let aprendizAEliminar = null;

        document.querySelector('#aprendicesTable').addEventListener('click', function(e) {
            const eliminarBtn = e.target.closest('.eliminar-aprendiz');
            if (!eliminarBtn) return;

            aprendizAEliminar = eliminarBtn.dataset.id;
            confirmDeleteModal.show();
        });

        document.getElementById('confirmDelete').addEventListener('click', async function() {
            if (!aprendizAEliminar) return;

            try {
                const response = await fetch(`/admin/aprendiz/eliminar/${aprendizAEliminar}`, {
                    method: 'DELETE'
                });
                const data = await response.json();

                if (data.success) {
                    showSuccessMessage('Aprendiz eliminado correctamente');
                    tabla.ajax.reload();
                } else {
                    throw new Error(data.message || 'Error al eliminar el aprendiz');
                }
            } catch (error) {
                showErrorMessage(error.message);
                console.error('Error:', error);
            } finally {
                confirmDeleteModal.hide();
                aprendizAEliminar = null;
            }
        });

        // Botones de exportación personalizados
        document.getElementById('exportExcel').addEventListener('click', function() {
            tabla.button('.buttons-excel').trigger();
        });

        document.getElementById('exportPDF').addEventListener('click', function() {
            tabla.button('.buttons-pdf').trigger();
        });
    });
</script>
</body>
</html>
